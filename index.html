<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script src="./tooltip.js"></script>
    <link rel="stylesheet" href="./styles.css">
</head>

<body>
    <h1>Employment & Education in the United States</h1>

    <h2>Part I: How well-employed is your county?</h2>
    <h3>Select your home county to see its employment rate ranking as compared to other counties.
    </h3>
    <div id="user_state_county_inputs">
        <label for="pick_state_input">Home State: </label>
        <select name="pick_state_input" id="pick_state_input">
            <option value="" disabled selected>Select your state</option>
        </select>

        <label for="pick_county_input">Home County: </label>
        <select name="pick_county_input" id="pick_county_input">
            <option value="" selected>Select your county</option>
        </select>

    </div>
    <br>

    <div class="colorLegend_elm1" style="margin-left: 450px;">
        <svg id="colorLegend" height="50" width="500" style="background: #fff; font-family: 'Lato', arial;
            font-size: 16px; font-weight: 300;"></svg>
    </div>

    <div class="visualization_1">
        <div id="state_min_div" class="viz_1_map element_1" style="display: none; padding-top: 100px;">
            <svg id="state_min" height="400" width="400"></svg>
        </div>
        <div class="viz_1_map element_2">
            <div id="viz_1_outline">
                <svg id="user_state" height="600" width="600"></svg>
            </div>
        </div>
        <div id="state_max_div" class="viz_1_map element_3" style="display: none;padding-top: 100px;">
            <svg id="state_max" height="400" width="400"></svg>
        </div>
    </div>

    <h2 class="pt2">Part II: Discover other counties</h2>
    <h3 class="pt2">Starting with the counties most similar to yours, explore other counties in the US by filtering for
        metrics such as income, literacy, and education.</h3>
    <div class="viz2" style="width: 100%;">
        <div id="us_div" style="width: 70%; height:800px; float: left;">
            <svg id="us_map" height="800" width="1200"></svg>
        </div>
        <div id="filters" style="height:800px; width: 20%; float:left; padding-left: 5%; padding-right: 5%;"></div>
    </div>
    <h3 class="pt2">Click on any county to compare it with yours!</h3>
    <div class="viz3_title">
        <h2 class="pt3">Part III: Compare two counties</h2>
        <h3 class="pt3">Based on your exploration from Part II, select one county to compare and contrast with your home
            county.
        </h3>
        <!-- <button id="reset">Click to pick 2 other counties!</button> -->
    </div>

    <div class="v3" style="display: flex;">
        <div class="v3_map element_1" style="width: 50%">
            <svg id="v3_c1" height="600" width="600"></svg>
        </div>
        <div class="v3_map element_2" style="width: 50%">
            <svg id="v3_c2" height="600" width="600"></svg>
        </div>
    </div>

    <div class="miniGraphs_1">
        <div>
            <svg id="hs_graph" height="300" width="500" style="margin-top: 50px;"></svg>
        </div>
        <div>
            <svg id="employment_graph" height="300" width="500" style="margin-top: 50px;"></svg>
        </div>
    </div>
    <div class="miniGraphs_2">
        <div class="ethnicity_title" style="margin-top: 50px;">
            <svg id="ethnicity_graphs_title" height="25" width="500"></svg>
        </div>
        <div class="ethnicity_graphs">
            <svg id="ethnicity_graph1" height="300" width="500" style="margin-top: 0px;"></svg>
            <svg id="ethnicity_graph2" height="300" width="500" style="margin-top: 0px;"></svg>
        </div>
        <div class="ethnicity_legend_div" height="75" width="1000" style="margin-left:50px">
            <svg id="ethnicity_legend" height="75" width="1000"></svg>
        </div>
    </div>

    <script>
        const us_svg = d3.select("#us_map");
        var scale = [1300, 550, 400]

        const request_data = async function () {
            const us = await d3.json("counties-10m.json");

            var us_projection = d3.geoAlbersUsa().scale(scale[0]).translate([scale[1], scale[2]]);
            var us_path = d3.geoPath().projection(us_projection);

            var nation = topojson.feature(us, us.objects.nation);
            var states = topojson.feature(us, us.objects.states)
            var counties = topojson.feature(us, us.objects.counties);

            var statesMesh = topojson.mesh(us, us.objects.states);
            var countiesMesh = topojson.mesh(us, us.objects.counties);

            // import datasets and populate new json
            var employment = await d3.csv("employment_data.csv", d3.autoType);
            var education = await d3.csv("education.csv", d3.autoType);
            var income = await d3.csv("unemployment_income.csv", d3.autoType);

            // color scale constants
            var all_employment_values = [];
            const colorsArray = ["#B5375D", "#DBADA6", "#DEDEDE", "#A1D5ED", "#26C7CB"];

            //new json with only data we need
            data = {}
            counties.features.forEach((county, i) => {
                data[Number(county.id)] = {};
            })

            employment.forEach((d, i) => {
                const id = d['FIPS_code'].toString()
                data[id]["employment_rate"] = d['Employed'];
                data[id]["state"] = d['State'].trim();
                data[id]["county_name"] = d['County'];
                data[id]["literacy"] = d["Lit_P3"];
                data[id]["OCC_Manage"] = 100 * d["OCC_Manage"];
                data[id]["OCC_Service"] = 100 * d["OCC_Service"];
                data[id]["OCC_Sales"] = 100 * d["OCC_Sales"];
                data[id]["OCC_Military"] = 100 * d["OCC_Military"];
                data[id]["OCC_Prod"] = 100 * d["OCC_Prod"];
                data[id]["Male"] = 100 * d["Male"];
                data[id]["Female"] = 100 * d["Female"];
                data[id]["White"] = 100 * d["White"];
                data[id]["Black"] = 100 * d["Black"];
                data[id]["Hispanic"] = 100 * d["Hispanic"];
                data[id]["Asian"] = 100 * d["Asian"];
                data[id]["AIAN"] = 100 * d["AIAN"];
                data[id]["NHPI"] = 100 * d["NHPI"];
                data[id]["Other_race"] = 100 * d["Other_race"];

                all_employment_values.push(d['Employed'])
            });

            education.forEach((d, i) => {
                const id = d['FIPS Code'];
                if (id in data) {
                    data[id]["high_school"] = d['Percent of adults with a high school diploma only, 2015-19'] + d["Percent of adults completing some college or associate's degree, 2015-19"] + d["Percent of adults with a bachelor's degree or higher, 2015-19"];
                    data[id]["college"] = d["Percent of adults with a bachelor's degree or higher, 2015-19"];
                    data[id]["Percent of adults with less than a high school diploma, 2015-19"] = d["Percent of adults with less than a high school diploma, 2015-19"];
                    data[id]["Percent of adults with a high school diploma only, 2015-19"] = d["Percent of adults with a high school diploma only, 2015-19"];
                    data[id]["Percent of adults with a bachelor's degree or higher, 2015-19"] = d["Percent of adults with a high school diploma only, 2015-19"];
                    data[id]["state_abbreviation"] = d['State'];
                }
            });


            // median income not pulling the right values
            income.forEach((d, i) => {
                const id = d['fips_txt']
                if (id in data && d["Attribute"] === "Median_Household_Income_2019") {
                    data[id]["income"] = d["Value"]
                }
            });


            const colorScale = d3.scaleQuantile()
                .domain(all_employment_values)
                .range(colorsArray);

            // array of all states to dropdown
            var all_states = [];
            states.features.forEach((state, i) => {
                state_name = state.properties.name;
                if (state_name != "Guam" && state_name != "American Samoa" && state_name != "Commonwealth of the Northern Mariana Islands" && state_name != "District of Columbia" && state_name != "United States Virgin Islands" && state_name != "Puerto Rico") {
                    all_states.push(state_name);
                }
            });
            all_states.sort();

            // add all states to select button
            d3.select("#pick_state_input")
                .selectAll('state_options')
                .data(all_states)
                .enter()
                .append('option')
                .text(d => { return d; })
                .attr("value", d => { return d; })

            // update county dropdown based on state selection
            d3.select("#pick_state_input").on("change", function (d) {
                var selected_state_input = d3.select(this).property("value");
                update_county_dropdown(selected_state_input);
            });

            make_state_map(42053, "#state_min", "#state_min_title");
            make_state_map(46117, "#state_max", "#state_max_title");

            function update_county_dropdown(user_state_input) {
                var user_counties = [];
                Object.keys(data).forEach((county) => {
                    if (data[county]['state'] === user_state_input) {
                        user_counties.push(data[county]['county_name']);
                    };
                });
                user_counties.sort();

                d3.selectAll('.county_options')
                    .remove();

                d3.select("#pick_county_input")
                    .selectAll('county_options')
                    .data(user_counties)
                    .enter()
                    .append('option').attr("class", 'county_options')
                    .text(d => { return d; })
                    .attr("value", d => { return d; })

                d3.select("#pick_county_input").on("change", function (d) {
                    var selected_county_input = d3.select(this).property("value");
                    user_county_id_input = find_county_id(user_state_input, selected_county_input);

                    //VISUALIZATION 1: STATES
                    d3.select("#state_max_div").style("display", "block")
                    d3.select("#state_min_div").style("display", "block")
                    make_state_map(user_county_id_input, "#user_state", "#user_state_title");

                    if (user_input_county_id_string.length === 4) {
                        user_input_state_id = "0" + user_input_county_id_string.substring(0, 1);
                        var full = "0" + user_input_county_id_string
                    }
                    else {
                        user_input_state_id = user_input_county_id_string.substring(0, 2);
                        var full = user_input_county_id_string
                    }

                    //VISUALIZATION 2: US MAP + FILTERS
                    const sliderWidth = 350
                    const sliderHeight = 30
                    d3.select("#filters").html("")
                    var brushes = []
                    brushes.push(makeSlider(d3.select("#filters"), "% Employed", "employment_rate", sliderHeight, sliderWidth, counties, us_path, statesMesh, user_county_id_input, data))
                    brushes.push(makeSlider(d3.select("#filters"), "Median Household Income", "income", sliderHeight, sliderWidth, counties, us_path, statesMesh, user_county_id_input, data))
                    brushes.push(makeSlider(d3.select("#filters"), "% of Adults at Level 3 Literacy", "literacy", sliderHeight, sliderWidth, counties, us_path, statesMesh, user_county_id_input, data))
                    brushes.push(makeSlider(d3.select("#filters"), "% Graduated High School", "high_school", sliderHeight, sliderWidth, counties, us_path, statesMesh, user_county_id_input, data))
                    brushes.push(makeSlider(d3.select("#filters"), "% with Bachelor's Degrees", "college", sliderHeight, sliderWidth, counties, us_path, statesMesh, user_county_id_input, data))

                    d3.select("#us_map").html("")
                    drawUS(counties, us_path, statesMesh, data, user_county_id_input, us, scale, countiesMesh)
                    usTooltip(data, us)

                    d3.selectAll(".pt2").style("display", "block")
                });
            };


            function find_county_id(state, county) {
                selected_county_id = "";
                employment.forEach((d, i) => {
                    if (d['State'].trim() === state && d['County'] === county) {
                        selected_county_id = d['FIPS_code'];
                    };
                });
                return selected_county_id;
            };

            function make_state_map(county_id, svg_id, title_id) {
                d3.select(svg_id).selectAll("*").remove();
                var state_projection = d3.geoAlbersUsa().scale(1).translate([0, 0]);
                var state_path = d3.geoPath().projection(state_projection);

                const state_svg = d3.select(svg_id);
                const state_width = state_svg.attr("width");
                const state_height = state_svg.attr("height");

                const margin = { top: 50, right: 0, bottom: 100, left: 0 };
                const mapWidth = state_width - margin.left - margin.right;
                const mapHeight = state_height - margin.top - margin.bottom;
                const map = state_svg.append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                user_input_county_id_string = county_id.toString();

                if (user_input_county_id_string.length === 4) {
                    user_input_state_id = "0" + user_input_county_id_string.substring(0, 1);
                    var full = "0" + user_input_county_id_string
                }
                else {
                    user_input_state_id = user_input_county_id_string.substring(0, 2);
                    var full = user_input_county_id_string
                }

                selected_state = states.features.filter(function (d) {
                    return d.id === user_input_state_id;
                });

                selected_counties = counties.features.filter(function (d) {
                    return d.id.substring(0, 2) === user_input_state_id;
                });

                // Source for centering state map: https://bl.ocks.org/gregdevs/a73f8a16f129757c037e72ecdebdd8f2
                var state_bounds = state_path.bounds(selected_state[0]);
                var state_x_difference = state_bounds[1][0] - state_bounds[0][0];
                var state_y_difference = state_bounds[1][1] - state_bounds[0][1];
                var state_x_sum = state_bounds[1][0] + state_bounds[0][0];
                var state_y_sum = state_bounds[1][1] + state_bounds[0][1];

                var state_scale = 0.95 / Math.max(state_x_difference / mapWidth, state_y_difference / mapHeight);
                var state_translate = [(mapWidth - state_scale * state_x_sum) / 2, (mapHeight - state_scale * state_y_sum) / 2];

                state_projection.scale(state_scale)
                    .translate(state_translate);

                map.selectAll("path.selected_counties")
                    .remove();

                //draw state map
                map.selectAll("path.selected_counties").data(selected_counties)
                    .join("path")
                    .attr("class", "selected_counties")
                    .attr("d", state_path)
                    .attr("fill", d => colorScale(Number(data[Number(d.id)]["employment_rate"])));

                map.append("path").datum(countiesMesh)
                    .attr("class", "outline")
                    .attr("d", state_path);

                // add state label
                state_svg.selectAll("text")
                    .remove();

                if (county_id === 42053) {
                    state_svg.append("text")
                        .attr("x", state_width / 2)
                        .attr("y", 30)
                        .attr("text-anchor", "middle")
                        .style("font-weight", 600)
                        .style("font-size", "16px")
                        .text(data[county_id]["county_name"] + ", " + data[county_id]["state_abbreviation"]);

                    state_svg.append("text")
                        .attr("x", state_width / 2)
                        .attr("y", 48)
                        .attr("text-anchor", "middle")
                        .style("font-weight", 300)
                        .style("font-size", "14px")
                        .text("has the lowest employment rate in the U.S.");
                }
                else if (county_id === 46117) {
                    state_svg.append("text")
                        .attr("x", state_width / 2)
                        .attr("y", 30)
                        .attr("text-anchor", "middle")
                        .style("font-weight", 600)
                        .style("font-size", "16px")
                        .text(data[county_id]["county_name"] + ", " + data[county_id]["state_abbreviation"]);

                    state_svg.append("text")
                        .attr("x", state_width / 2)
                        .attr("y", 48)
                        .attr("text-anchor", "middle")
                        .style("font-weight", 300)
                        .style("font-size", "14px")
                        .text("has the highest employment rate in the U.S.");
                }
                else {
                    state_svg.append("text")
                        .attr("x", state_width / 2)
                        .attr("y", 30)
                        .attr("text-anchor", "middle")
                        .style("font-weight", 600)
                        .style("font-size", "18px")
                        .text(data[county_id]["county_name"] + ", " + data[county_id]["state_abbreviation"]);
                }

                // add metrics
                const attributes = ["Employment Rate: ", "Median Household Income: ", "Pop. % at Level 3 Literacy: ", "Pop. % with Bachelors' Degrees: ", "Pop. % of High School Graduates: "];

                const metrics = [(Math.round(data[Number(county_id)]["employment_rate"] * 100).toString() + "%"),
                (d3.format(",")(Math.round(data[Number(county_id)]["income"])).toString() + "K"),
                (Math.round((data[Number(county_id)]["literacy"] * 100).toString()) + "%"),
                (Math.round(data[Number(county_id)]["college"]) + "%"),
                (Math.round(data[Number(county_id)]["high_school"]) + "%")];

                if (state_width === "400") {
                    attributes.forEach((d, i) => {
                        state_svg.append("text")
                            .attr("x", 0.1 * state_width)
                            .attr("y", state_height - (90 - 20 * i))
                            .style("font-weight", 600)
                            .style("font-size", "14px")
                            .text(d);
                    });

                    metrics.forEach((d, i) => {
                        state_svg.append("text")
                            .attr("x", 0.62 * state_width)
                            .attr("y", state_height - (90 - 20 * i))
                            .style("font-weight", 300)
                            .style("font-size", "14px")
                            .text(d)
                    })
                }
                else {
                    attributes.forEach((d, i) => {
                        state_svg.append("text")
                            .attr("x", 0.25 * state_width)
                            .attr("y", state_height - (90 - 20 * i))
                            .style("font-weight", 600)
                            .style("font-size", "14px")
                            .text(d);
                    });

                    metrics.forEach((d, i) => {
                        state_svg.append("text")
                            .attr("x", 0.60 * state_width)
                            .attr("y", state_height - (90 - 20 * i))
                            .style("font-weight", 300)
                            .style("font-size", "14px")
                            .text(d);
                    });
                };

                // add legend for selected state
                // Source: Professor. Rz, INFO 3300: Data-Driven Web Applications, Lecture 03/22, Spring 2021 Cornell University
                if (svg_id === "#user_state") {
                    const legend = d3.select("#colorLegend");
                    const legendWidth = legend.attr("width");
                    const legendHeight = legend.attr("height");
                    const legendColorScale = colorScale;
                    const legendMinMax = d3.extent(legendColorScale.domain());
                    const barHeight = 20;
                    const stepSize = 4;
                    const pixelScale = d3.scaleLinear().domain([0, legendWidth - 40]).range([legendMinMax[0], legendMinMax[1]]);
                    const barScale = d3.scaleLinear().domain([legendMinMax[0], legendMinMax[1]]).range([0, legendWidth - 40]);
                    const barAxis = d3.axisBottom(barScale).tickFormat(d3.format(".2f"));;

                    if (legendColorScale.hasOwnProperty('quantiles')) {

                        barAxis.tickValues(legendColorScale.quantiles().concat(legendMinMax));
                    }
                    legend.append("g")
                        .attr("class", "colorbar axis")
                        .attr("transform", "translate(" + (20) + "," + (barHeight + 5) + ")")
                        .call(barAxis);

                    let bar = legend.append("g").attr("transform", "translate(" + (20) + "," + (0) + ")")
                    for (let i = 0; i < legendWidth - 40; i = i + stepSize) {
                        bar.append("rect")
                            .attr("x", i)
                            .attr("y", 0)
                            .attr("width", stepSize)
                            .attr("height", barHeight)
                            .style("fill", legendColorScale(pixelScale(i)));
                    }
                    legend.selectAll("line").remove();
                    bar.append("line").attr("stroke", "black").attr("stroke-width", 3).attr("x1", barScale(data[Number(county_id)]["employment_rate"])).attr("x2", barScale(data[Number(county_id)]["employment_rate"])).attr("y1", 0).attr("y1", barHeight + 4);
                };

                // outline for selected state
                let momesh = map.append("path")
                    .attr("class", "select_outline")
                    .attr("d", "");

                map.append("path")
                    .attr("class", "mouseover_outline")
                    .attr("d", "")
                    .attr("id", "momesh")

                var mo = topojson.mesh(us, us.objects.counties, function (a, b) { return a.id === full || b.id === full });
                momesh.datum(mo).attr("d", state_path)

                add_tooltip(svg_id, data, us)
            };

            // DRAWS US MAP IN VISUALIZATION 2, AND CREATES HOVER TOOLTIP FOR IT

            const colorsArray2 = ["lightgrey", "#C7A9E3"];
            const colorScale2 = d3.scaleQuantize()
                .domain([0, 1])
                .range(colorsArray2);

            var filters = {};

            //returns true if county fulfills all filter criteria
            function matchCounties(county, data) {
                var pass = true
                Object.values(filters).forEach(filterFunc => {
                    if (!filterFunc(data[Number(county)])) {
                        pass = false
                    };
                });
                return pass
            };

            //updates colors for counties
            function updateUS(counties, us_path, data) {
                us_svg.selectAll("path.counties").data(counties.features)
                    .join("path")
                    .attr("class", "counties")
                    .attr("d", us_path)
                    .attr("fill", d => colorScale2(Number(matchCounties(d.id, data))));
            }

            //draws US map
            function drawUS(counties, us_path, statesMesh, data, county_id, us, scale, countiesMesh) {
                const margin = { top: 0, right: 0, bottom: 0, left: 0 };
                // const mapWidth = us_svg.attr("width") - margin.left - margin.right;
                // const mapHeight = us_svg.attr("height") - margin.top - margin.bottom;
                const map = us_svg.append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                map.selectAll("path.counties").data(counties.features)
                    .join("path")
                    .attr("class", "counties")
                    .attr("d", us_path)
                    .attr("fill", d => colorScale2(Number(matchCounties(d.id, data))));

                map.append("path").datum(countiesMesh)
                    .attr("class", "county_outline")
                    .attr("d", us_path);

                map.append("path").datum(statesMesh)
                    .attr("class", "outline")
                    .attr("d", us_path);

                let momesh = map.append("path")
                    .attr("class", "select_outline_us")
                    .attr("d", "")
                    .attr("id", "momesh2");

                map.append("path")
                    .attr("class", "mouseover_outline")
                    .attr("d", "")
                    .attr("id", "momesh")

                map.append("path")
                    .attr("class", "select_outline_us")
                    .attr("d", "")
                    .attr("id", "county2");


                var state_projection = d3.geoAlbersUsa().scale(1).translate([0, 0]);
                var state_path = d3.geoPath().projection(state_projection);

                if (user_input_county_id_string.length === 4) {
                    user_input_state_id = "0" + user_input_county_id_string.substring(0, 1);
                    var county_id = "0" + user_input_county_id_string
                }
                else {
                    user_input_state_id = user_input_county_id_string.substring(0, 2);
                    var county_id = user_input_county_id_string
                }

                selected_state = states.features.filter(function (d) {
                    return d.id === county_id.substring(0, 2);
                });

                var state_projection = d3.geoAlbersUsa().scale(1).translate([0, 0]);
                var state_path = d3.geoPath().projection(state_projection);

                bounds = state_path.bounds(selected_state[0]);
                var state_scale = scale[0]
                var state_translate = [scale[1] + (bounds[0][0]) / 2, scale[2] + (bounds[0][1]) / 2];

                state_projection.scale(state_scale)
                    .translate(state_translate);
                state_projection.translate(state_translate);

                var mo = topojson.mesh(us, us.objects.counties, function (a, b) { return a.id === county_id.toString() || b.id === county_id.toString(); });
                momesh.datum(mo).attr("d", state_path)
            }

            function makeSlider(container, label, attribute, sliderHeight, sliderWidth, counties, us_path, statesMesh, selected_county, data) {
                let values = []
                let format = d3.format(".0%")
                Object.keys(data).forEach((county) => {
                    let value = data[county][attribute]

                    if (attribute === "college" || attribute === "high_school") {
                        value /= 100
                    } else if (attribute === "income") {
                        format = d3.format("$.2s")
                    }
                    values.push(value);
                });

                let select_value = data[selected_county][attribute]

                if (attribute === "college" || attribute === "high_school") {
                    select_value /= 100
                }

                let minMax = d3.extent(values);
                let xScale = d3.scaleLinear().domain(minMax).range([10, sliderWidth - 10]);
                let xAxis = d3.axisBottom(xScale).tickFormat(format);

                let wrapper = container.append("div").attr("class", "control").style("margin-bottom", "40px");
                wrapper.append("div").text(label).style("font-weight", "bold").style("margin-bottom", "5px");
                wrapper.append("div").text("").attr("id", "values" + attribute).style("display", "none");
                let canvas = wrapper.append("svg").attr("width", sliderWidth)
                    .attr("height", sliderHeight + 40)
                    .attr("attribute", attribute);
                let areaLayer = canvas.append("g");
                canvas.append("g").attr("transform", `translate(0,${sliderHeight})`)
                    .call(xAxis);
                canvas.append("rect").attr("transform", `translate(${xScale(select_value)}, 0)`)
                    .attr("width", 2)
                    .attr("height", sliderHeight)
                    .attr("fill", "#C11515")

                let numBins = 15;
                let histoGen = d3.histogram().domain(minMax)
                    .thresholds(numBins);
                let counts = histoGen(values);

                counts.unshift({
                    x0: 0,
                    x1: counts[0].x0,
                    length: counts[0].length
                });

                let yScale = d3.scaleLinear().domain(d3.extent(counts, d => d.length))
                    .range([sliderHeight, 4]);

                let area = d3.area().x(d => xScale(d.x1))
                    .y0(yScale(0))
                    .y1(d => yScale(d.length))
                    .curve(d3.curveNatural);
                areaLayer.append("path").datum(counts)
                    .attr("class", "area")
                    .attr("d", area);

                const defaultSelection = [Math.max(0, select_value - minMax[1] * 0.1), Math.min(minMax[1], select_value + minMax[1] * 0.1)]
                const defaultBar = [xScale(defaultSelection[0]), xScale(defaultSelection[1])]

                d3.select("#values" + attribute).text(defaultSelection[0].toString().substring(0, 5) + " - " + defaultSelection[1].toString().substring(0, 5))

                const text = wrapper.select("#values" + attribute).text()
                const dash = text.indexOf("-")

                var start = Number(text.substring(0, dash - 1))
                var end = Number(text.substring(dash + 1))
                if (attribute === "college" || attribute === "high_school") {
                    start *= 100
                    end *= 100
                }

                let filterFunc = d => d[attribute] >= start && d[attribute] <= end;
                filters[attribute] = filterFunc;

                updateUS(counties, us_path, data)

                var brush = d3.brushX().extent([[10, 0],
                [sliderWidth - 10, sliderHeight]])
                    .on("brush end", brushMoved);

                function brushMoved(event) {
                    if (event.selection !== null) {
                        start = xScale.invert(event.selection[0]);
                        end = xScale.invert(event.selection[1]);
                        if (attribute === "college" || attribute === "high_school") {
                            start *= 100
                            end *= 100
                        }

                        const text = d3.select(this.parentNode.parentNode).select("#values" + attribute).text()
                        const dash = text.indexOf("-")

                        let filterFunc = d => d[attribute] >= Number(text.substring(0, dash - 1)) && d[attribute] <= Number(text.substring(dash + 1));
                        filters[attribute] = filterFunc;

                        d3.select(this.parentNode.parentNode).select("#values" + attribute).text(start.toString().substring(0, 5) + " - " + end.toString().substring(0, 5))
                        updateUS(counties, us_path, data)
                    }
                    else {
                        let filterFunc = d => true;
                        filters[attribute] = filterFunc;
                        d3.select(this.parentNode.parentNode).select("#values" + attribute).text("No Filter")
                        updateUS(counties, us_path, data)

                    }
                }
                canvas.append("g").attr("class", "brush" + attribute).call(brush)
                    .call(brush.move, defaultBar);
                return brush
            }

            function usTooltip(data, us) {
                const tooltipWidth = 300;
                const tooltipHeight = 135;
                let svg = d3.select("#us_map");

                let tooltip = svg.append("g")
                    .attr("class", "us_tooltip")
                    .style("visibility", "hidden")
                    .attr("id", "tooltip")

                tooltip.append("rect")
                    .attr("fill", "white")
                    .attr("opacity", 0.9)
                    .attr("rx", "15")
                    .attr("stroke", "grey")
                    .attr("stroke-width", "1px")
                    .attr("x", -tooltipWidth / 2.0)
                    .attr("y", 0)
                    .attr("width", tooltipWidth)
                    .attr("height", tooltipHeight)

                //text
                const attributes = ["name", "employment", "income", "literacy", "college", "highschool"]
                var y = 10
                attributes.forEach((d) => {
                    tooltip.append("text")
                        .attr("fill", "black")
                        .attr("text-anchor", "middle")
                        .attr("alignment-baseline", "hanging")
                        .attr("x", 0)
                        .attr("y", y)
                        .attr("id", d)

                    y += 20
                })

                d3.selectAll(".counties").on("mouseenter", mouseEntersPlot);
                d3.selectAll(".counties").on("mouseout", mouseLeavesPlot);

                var county2;
                var v2countyID1;
                var v2countyID2;
                d3.selectAll(".counties").on("click", function (d) {
                    // county1 = d3.select(this).datum();
                    // v2countyID1 = county1.id;
                    v2countyID1 = user_county_id_input.toString();

                    county2 = d3.select(this).datum();
                    v2countyID2 = county2.id.toString();

                    // attempt to highlight selected county
                    var state_projection = d3.geoAlbersUsa().scale(1).translate([0, 0]);
                    var state_path = d3.geoPath().projection(state_projection);

                    bounds = state_path.bounds(selected_state[0]);
                    var state_scale = scale[0]
                    var state_translate = [scale[1] + (bounds[0][0]) / 2, scale[2] + (bounds[0][1]) / 2];

                    state_projection.scale(state_scale)
                        .translate(state_translate);
                    state_projection.translate(state_translate);

                    var svg = d3.select(this.parentNode.parentNode);
                    const map = svg.selectAll("g")

                    if (v2countyID2.length === 4) {
                        var full = "0" + v2countyID2
                    }
                    else {
                        var full = v2countyID2
                    }

                    var mo = topojson.mesh(us, us.objects.counties, function (a, b) { return a.id === v2countyID2 || b.id === v2countyID2 });
                    svg.select("#county2").datum(mo).attr("d", state_path).style("stroke", "darkblue");

                    viz3(Number(v2countyID1), Number(v2countyID2));
                    d3.selectAll(".pt3").style("display", "block")

                });

                function mouseEntersPlot() {
                    const svg = d3.select(this.parentNode.parentNode);
                    const width = svg.attr("width");
                    const height = svg.attr("height");
                    tooltip = svg.select("#tooltip")
                    let county = d3.select(this).datum();
                    let countyID = county.id;

                    //calculating translation and scale for tooltip placement
                    var states = topojson.feature(us, us.objects.states)
                    selected_state = states.features.filter(function (d) {
                        return d.id === countyID.substring(0, 2);
                    });

                    var state_projection = d3.geoAlbersUsa().scale(1).translate([0, 0]);
                    var state_path = d3.geoPath().projection(state_projection);

                    bounds = state_path.bounds(selected_state[0]);
                    var state_scale = scale[0]
                    var state_translate = [scale[1] + (bounds[0][0]) / 2, scale[2] + (bounds[0][1]) / 2];

                    state_projection.scale(state_scale)
                        .translate(state_translate);
                    state_projection.translate(state_translate);

                    bounds = state_path.bounds(county);
                    let xPos = (bounds[0][0] + bounds[1][0]) / 2.0;
                    let yPos = bounds[1][1];

                    //if tooltip goes outside svg
                    if (xPos + tooltipWidth / 2 > width) {
                        xPos = (bounds[0][0] - tooltipWidth / 2)
                    } else if (xPos - tooltipWidth / 2 < 0) {
                        xPos = bounds[0][0] + tooltipWidth / 2
                    }
                    if (yPos + tooltipHeight > height) {
                        yPos = bounds[1][1] - tooltipHeight - 30
                    }

                    //highlight outline
                    var mo = topojson.mesh(us, us.objects.counties, function (a, b) { return a.id === countyID || b.id === countyID });
                    svg.select("#momesh").datum(mo).attr("d", state_path)

                    //update text and show tooltip
                    tooltip.style("visibility", "visible")
                    tooltip.attr("transform", `translate(${xPos},${yPos})`);

                    svg.select("#name").text("County: " + data[Number(countyID)]["county_name"] + ", " + data[Number(countyID)]["state_abbreviation"])
                    svg.select("#employment").text("Employment Rate: " + Math.round(data[Number(countyID)]["employment_rate"] * 100).toString() + "%");
                    svg.select("#income").text("Median Household Income: " + data[Number(countyID)]["income"].toString());
                    svg.select("#literacy").text("Pop. % at Level 3 Literacy: " + Math.round((data[Number(countyID)]["literacy"] * 100).toString()) + "%");
                    svg.select("#college").text("Pop. % with Bachelors' Degrees: " + Math.round(data[Number(countyID)]["college"]) + "%");
                    svg.select("#highschool").text("Pop. % of High School Graduates: " + Math.round(data[Number(countyID)]["high_school"]) + "%");
                }

                function mouseLeavesPlot() {
                    const svg = d3.select(this.parentNode.parentNode)
                    tooltip = svg.select("#tooltip").style("visibility", "hidden");
                    svg.select("#momesh").attr("d", "");
                }
            }

            function viz3(compare1, compare2) {
                make_state_map(compare1, "#v3_c1", "#v3_c1_title");
                make_state_map(compare2, "#v3_c2", "#v3_c2_title");

                const svg_education = d3.select("svg#hs_graph");
                const svg_employment = d3.select("svg#employment_graph");

                // draw bar charts
                bar_charts(svg_education, "Education", ["Less than High School Diploma", "High School Diploma",
                    "Bachelor's Degree or Higher"], ["Percent of adults with less than a high school diploma, 2015-19",
                    "Percent of adults with a high school diploma only, 2015-19",
                    "Percent of adults with a bachelor's degree or higher, 2015-19"], 3);

                bar_charts(svg_employment, "Employment", ["Management", "Service", "Sales", "Military", "Production"],
                    ["OCC_Manage", "OCC_Service", "OCC_Sales", "OCC_Military", "OCC_Prod"], 5);

                // function to create bar charts 
                function bar_charts(svg, title, x_list, y_list, max) {
                    svg.selectAll("text").remove();
                    svg.selectAll("line").remove();

                    const width = svg.attr("width");
                    const height = svg.attr("height");
                    const margin = { "top": 40, "right": 10, "bottom": 50, "left": 60 };
                    const chartWidth = width - margin.left - margin.right;
                    const chartHeight = height - margin.top - margin.bottom

                    let annotations = svg.append("g").attr("id", "annotations");
                    let chartArea = svg.append("g").attr("id", "points")
                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                    const yaxisScale = d3.scaleLinear().domain([0, 100]).range([chartHeight, 0])
                    let leftAxis = d3.axisLeft(yaxisScale).tickFormat(d3.format(''));
                    let leftGridlines = d3.axisLeft(yaxisScale)
                        .tickSize(-chartWidth - 10)
                        .tickFormat("")

                    annotations.append("g")
                        .attr("class", "y axis")
                        .attr("transform", `translate(${margin.left - 10},${margin.top})`)
                        .call(leftAxis)
                    annotations.append("g")
                        .attr("class", "y_gridlines")
                        .attr("transform", `translate(${margin.left - 10},${margin.top})`)
                        .call(leftGridlines);

                    const xaxisScale = d3.scalePoint()
                        .domain(x_list)
                        .range([20, chartWidth - 70]);

                    const xaxisScale2 = d3.scalePoint()
                        .domain(x_list)
                        .range([50, chartWidth - 40]);

                    let bottomAxis = d3.axisBottom(xaxisScale)
                    let bottomAxisG = annotations.append("g")
                        .attr("class", "x axis")
                        .attr("transform", `translate(${margin.left},${chartHeight + margin.top + 10})`)
                        .call(bottomAxis);

                    // chart title
                    svg.append("text")
                        .attr("x", width / 2)
                        .attr("y", 25)
                        .style("text-anchor", "middle")
                        .style("font-weight", 600)
                        .style("font-size", "16px")
                        .text(title);

                    // county 1 label
                    svg.append("text")
                        .attr("x", 0.35 * width)
                        .attr("y", height - 5)
                        .style("text-anchor", "middle")
                        .style("font-weight", 200)
                        .style("font-size", "12px")
                        .style("stroke", "#80b1d3")
                        .text(data[Number(compare1)]["county_name"] + ", " + data[Number(compare1)]["state_abbreviation"]);

                    // county 2 label
                    svg.append("text")
                        .attr("x", 0.75 * width)
                        .attr("y", height - 5)
                        .style("text-anchor", "middle")
                        .style("font-weight", 200)
                        .style("font-size", "12px")
                        .style("stroke", "#fb8072")
                        .text(data[Number(compare2)]["county_name"] + ", " + data[Number(compare2)]["state_abbreviation"]);

                    // y axis label
                    svg.append("text")
                        .attr("transform", "rotate(-90)")
                        .attr("y", 0)
                        .attr("x", 0 - (height / 2))
                        .attr("dy", "1em")
                        .style("text-anchor", "middle")
                        .style("font-family", "'Lato', arial")
                        .style("font-size", "10px")
                        .style("font-weight", 300)
                        .text("Percentage");

                    // draw County 1 rectangles
                    for (i = 0; i < max; i++) {
                        chartArea.append("line")
                            .attr("x1", xaxisScale(x_list[i]))
                            .attr("x2", xaxisScale(x_list[i]))
                            .attr("y1", chartHeight)
                            .attr("y2", yaxisScale(data[compare1][y_list[i]]))
                            .attr("id", Math.round(data[compare1][y_list[i]]))
                            .style("stroke", "#80b1d3")
                            .style("stroke-width", 30)
                            .on("mouseover", function () {
                                d3.select(this)
                                    .style("stroke", "#0096FF");

                                chartArea.append("text")
                                    .attr("x", d3.select(this).attr("x1"))
                                    .attr("y", d3.select(this).attr("y2") - 5)
                                    .attr("class", "bar_numbers")
                                    .style("text-anchor", "middle")
                                    .style("font-weight", 300)
                                    .style("font-size", "12px")
                                    .style("stroke", "#0096FF")
                                    .text(d3.select(this).attr("id").toString() + "%");
                            })
                            .on("mouseout", function () {
                                d3.select(this)
                                    .style("stroke", "#80b1d3");

                                d3.selectAll(".bar_numbers").remove();
                            });
                    };

                    // draw County 2 rectangles
                    for (i = 0; i < max; i++) {
                        chartArea.append("line")
                            .attr("x1", xaxisScale2(x_list[i]))
                            .attr("x2", xaxisScale2(x_list[i]))
                            .attr("y1", chartHeight)
                            .attr("y2", yaxisScale(data[compare2][y_list[i]]))
                            .attr("id", Math.round(data[compare2][y_list[i]]))
                            .style("stroke", "#fb8072")
                            .style("stroke-width", 30)
                            .on("mouseover", function () {
                                d3.select(this)
                                    .style("stroke", "#F93D28");

                                chartArea.append("text")
                                    .attr("x", d3.select(this).attr("x1"))
                                    .attr("y", d3.select(this).attr("y2") - 5)
                                    .attr("class", "bar_numbers")
                                    .style("text-anchor", "middle")
                                    .style("font-weight", 300)
                                    .style("font-size", "12px")
                                    .style("stroke", "#F93D28")
                                    .text(d3.select(this).attr("id").toString() + "%");
                            })
                            .on("mouseout", function () {
                                d3.select(this)
                                    .style("stroke", "#fb8072");

                                d3.selectAll(".bar_numbers").remove();
                            });
                    };

                };

                // ETHNICITY OF PIE CHART CHART MINI GRAPH
                const svg4 = d3.select("svg#ethnicity_graph1");
                const svg4_part2 = d3.select("svg#ethnicity_graph2");
                const width4 = svg4.attr("width");
                const height4 = svg4.attr("height");
                const margin4 = 70;
                const radius4 = Math.min(width4, height4) / 2 - margin4;

                svg4.selectAll("text").remove();
                svg4_part2.selectAll("text").remove();
                d3.select("#ethnicity_graphs_title").selectAll("text").remove();
                d3.select("#ethnicity_legend").selectAll("text").remove();

                g4 = svg4.append("g").attr("transform", "translate(" + width4 / 2 + "," + height4 / 2 + ")");
                g5 = svg4_part2.append("g").attr("transform", "translate(" + width4 / 2 + "," + height4 / 2 + ")");

                var color4 = d3.scaleOrdinal(["#4e79a7", "#f28e2c", "#e15759", "#76b7b2", "#59a14f", "#edc949", "#af7aa1"]);

                //chart title
                d3.select("#ethnicity_graphs_title").append("text")
                    .attr("x", 500 / 2)
                    .attr("y", 15)
                    .style("text-anchor", "middle")
                    .style("font-weight", 600)
                    .style("font-size", "16px")
                    .text("Ethnicity Graphs");

                // County 1 label
                svg4.append("text")
                    .attr("x", width4 / 2)
                    .attr("y", height4 - 55)
                    .style("text-anchor", "middle")
                    .style("font-weight", 200)
                    .text(data[Number(compare1)]["county_name"] + ", " + data[Number(compare1)]["state_abbreviation"]);

                // County 2 label
                svg4_part2.append("text")
                    .attr("x", width4 / 2)
                    .attr("y", height4 - 55)
                    .style("text-anchor", "middle")
                    .style("font-weight", 200)
                    .text(data[Number(compare2)]["county_name"] + ", " + data[Number(compare2)]["state_abbreviation"]);

                var ethnicity_data1 = [data[compare1]["White"], data[compare1]["Black"],
                data[compare1]["Hispanic"], data[compare1]["Asian"],
                data[compare1]["AIAN"], data[compare1]["NHPI"],
                data[compare1]["Other_race"]];

                var ethnicity_data2 = [data[compare2]["White"], data[compare2]["Black"],
                data[compare2]["Hispanic"], data[compare2]["Asian"],
                data[compare2]["AIAN"], data[compare2]["NHPI"],
                data[compare2]["Other_race"]];

                // Colored graph labels
                const ethnicity_x_pixels = [120, 120, 320, 320, 520, 520, 720];
                const ethnicity_y_pixels = [20, 35, 20, 35, 20, 35, 20];
                const ethnicity_labels = ["White", "Black", "Hispanic", "Asian",
                    "Native American", "Pacific Islander",
                    "Other Races"]

                const ethnicity_colors = ["#4e79a7", "#f28e2c", "#e15759", "#76b7b2", "#59a14f", "#edc949", "#af7aa1"];

                for (i = 0; i < 8; i++) {
                    d3.select("#ethnicity_legend").append("text")
                        .attr("x", ethnicity_x_pixels[i])
                        .attr("y", ethnicity_y_pixels[i])
                        .style("font-weight", 200)
                        .attr("font-size", "14px")
                        .style("stroke", ethnicity_colors[i])
                        .text(ethnicity_labels[i]);
                }

                // Generate the pie
                var pie4 = d3.pie();
                var pie5 = d3.pie();

                // Generate the arcs
                var arc4 = d3.arc()
                    .innerRadius(20)
                    .outerRadius(radius4);

                var arc5 = d3.arc()
                    .innerRadius(20)
                    .outerRadius(radius4);

                //Generate groups
                var arcs4 = g4.selectAll("arc")
                    .data(pie4(ethnicity_data1))
                    .enter()
                    .append("g")
                    .attr("class", "arc4")

                var arcs5 = g5.selectAll("ar2")
                    .data(pie5(ethnicity_data2))
                    .enter()
                    .append("g")
                    .attr("class", "arc5")

                //Draw arc paths
                arcs4.append("path")
                    .attr("fill", function (d, i) {
                        return color4(i);
                    })
                    .attr("d", arc4)
                    .on("mouseover", function (d, i) {
                        const ethnicity_labels = ["White", "Black", "Hispanic", "Asian",
                            "Native American", "Pacific Islander",
                            "Other or", "Combination"]

                        var ethnicity_data1 = [data[compare1]["White"], data[compare1]["Black"],
                        data[compare1]["Hispanic"], data[compare1]["Asian"],
                        data[compare1]["AIAN"], data[compare1]["NHPI"],
                        data[compare1]["Other_race"]];

                        var arc_index = ethnicity_data1.indexOf(i['value']);

                        d3.select(this)
                            .attr("stroke", "black")
                            .attr("stroke-width", "3px");

                        svg4.append("text")
                            .attr("x", width4 / 2)
                            .attr("y", 50)
                            .attr("class", "arc_label")
                            .style("text-anchor", "middle")
                            .style("font-size", "14px")
                            .text(ethnicity_labels[arc_index] + ": " + (Math.round(i['value'])).toString() + "%");
                    })
                    .on("mouseout", function (d, i) {
                        d3.select(this)
                            .attr("stroke", "none")
                            .attr("stroke-width", "none");

                        svg4.select(".arc_label").remove();
                    });


                arcs5.append("path")
                    .attr("fill", function (d, i) {
                        return color4(i);
                    })
                    .attr("d", arc5)
                    .on("mouseover", function (d, i) {
                        const ethnicity_labels = ["White", "Black", "Hispanic", "Asian",
                            "Native American", "Pacific Islander",
                            "Other or", "Combination"]

                        var ethnicity_data2 = [data[compare2]["White"], data[compare2]["Black"],
                        data[compare2]["Hispanic"], data[compare2]["Asian"],
                        data[compare2]["AIAN"], data[compare2]["NHPI"],
                        data[compare2]["Other_race"]];

                        var arc_index = ethnicity_data2.indexOf(i['value']);

                        d3.select(this)
                            .attr("stroke", "black")
                            .attr("stroke-width", "3px");

                        svg4_part2.append("text")
                            .attr("x", width4 / 2)
                            .attr("y", 50)
                            .attr("class", "arc_label")
                            .style("text-anchor", "middle")
                            .style("font-size", "14px")
                            .text(ethnicity_labels[arc_index] + ": " + (Math.round(i['value'])).toString() + "%");
                    })
                    .on("mouseout", function (d, i) {
                        d3.select(this)
                            .attr("stroke", "none")
                            .attr("stroke-width", "none");

                        svg4_part2.select(".arc_label").remove();
                    });
            };
        }
        request_data();
    </script>
</body>

</html>