<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;1,300;1,700&display=swap');

        body {
            font-family: 'Lato', arial;
            font-size: 14px;
            font-weight: 400;
        }

        #pick_county_input {
            font-family: 'Lato', arial;
            font-size: 16px;
            font-weight: 300;
        }

        #pick_state_input {
            font-family: 'Lato', arial;
            font-size: 16px;
            font-weight: 300;
        }

        #reset_button {
            font-family: 'Lato', arial;
            font-size: 16px;
            font-weight: 300;
        }

        label {
            font-size: 16px;
            font-weight: 300;
        }

        h2 {
            font-weight: 300;
        }

        .state {
            fill: #ddd;
        }

        /* .selected_counties {
            fill: #ddd;
        } */

        .outline {
            stroke: #fff;
            stroke-width: 1px;
            fill: none;
        }

        .visualization_1 {
            display: flex;
        }

        .viz_1_map {
            flex: 1;
        }

        .mouseover_outline {
            stroke: black;
            stroke-width: 1px;
            fill: none;
        }
    </style>
</head>

<body>
    <h1>How well-employed is your county?</h1>

    <div id="user_state_county_inputs">
        <label for="pick_state_input">Select your home state: </label>
        <select name="pick_state_input" id="pick_state_input">
            <option value="" disabled selected>Select your state</option>
        </select>
        <!-- <br> -->

        <label for="pick_county_input">Select your home county: </label>
        <select name="pick_county_input" id="pick_county_input">
            <!-- need to dynamically populate dropdown with JS -->
            <option value="" disabled selected>Select your county</option>
        </select>

        <button type="button" id="reset_button">Reset</button>
    </div>

    <!-- <label for="zip_code_input">Select your zip code: </label>
    <input type="text" id="zip_code_input" placeholder="Type your zipcode here" minlength="5" maxlength="5"> -->

    <div id="all_svgs">
        <div class="visualization_1">
            <div class="viz_1_map element_1">
                <svg id="state_min" height="400" width="600"></svg>
            </div>
            <div class="viz_1_map element_2">
                <svg id="user_state" height="400" width="600"></svg>
            </div>
            <div class="viz_1_map element_3">
                <svg id="state_max" height="400" width="600"></svg>
            </div>
        </div>
        <svg id="us_map" height="600" width="1000"></svg>
        <!-- <svg id="chart2b" height="500" width="800"></svg>
        <svg id="chart2c" height="200" width="300"></svg>
        <svg id="chart2d" height="200" width="300"></svg> -->
    </div>

    <div id="buttonLiteracy"></div>

    <script>
        // PART 1: COUNTY VISUALIZATION (SHRUTI)
        //state map

        //us map
        const us_svg = d3.select("#us_map");
        const us_width = us_svg.attr("width");
        const us_height = us_svg.attr("height");
        // const us_mapWidth = us_width;
        // const us_mapHeight = us_height;

        // US Map 2 (Rachel)
        // const us2 = d3.select("#usmap2");
        // const us2width = us2.attr("width");
        // const us2height = us2.attr("height");
        // const us2map = us2.append("g");

        const request_data = async function () {
            //load us map json
            const us = await d3.json("counties-10m.json");

            var us_projection = d3.geoAlbersUsa().scale(1300).translate([487.5, 305]);
            var us_path = d3.geoPath().projection(us_projection);

            // var state_projection = d3.geoAlbersUsa().scale(1).translate([0, 0]);
            // var state_path = d3.geoPath().projection(state_projection);

            var nation = topojson.feature(us, us.objects.nation);
            var counties = topojson.feature(us, us.objects.counties);
            var states = topojson.feature(us, us.objects.states)
            var statesMesh = topojson.mesh(us, us.objects.states);
            var countiesMesh = topojson.mesh(us, us.objects.counties);

            // datasets
            var zip_codes = await d3.csv("fipscode_zipcode.csv", d3.autoType);
            var employment = await d3.csv("employment_data.csv", d3.autoType);
            var education = await d3.csv("education_data.csv", d3.autoType);

            // populating variables for counties
            counties.features.forEach((county, i) => {
                employment.forEach((d, i) => {
                    employment_rate = d['Employed'];
                    state = d['State'].trim();
                    county_name = d['County'];
                    if (Number(county.id) === d['FIPS_code']) {
                        county.properties["employment_rate"] = employment_rate;
                        county.properties["state"] = state;
                        county.properties["county_name"] = county_name;
                    }
                });
            });

            // var all_zipcodes = []
            // zip_codes.forEach((county, i) => {
            //     county_zipcode = county.ZIP;
            //     all_zipcodes.push(county_zipcode);
            // });

            // array of all states to dropdown
            var all_states = [];
            states.features.forEach((state, i) => {
                state_name = state.properties.name;
                all_states.push(state_name);
            });
            all_states.sort();

            // add all states to select button
            d3.select("#pick_state_input")
                .selectAll('state_options')
                .data(all_states)
                .enter()
                .append('option')
                .text(d => { return d; })
                .attr("value", d => { return d; })

            // update county dropdown based on state selection
            d3.select("#pick_state_input").on("change", function (d) {
                var selected_state_input = d3.select(this).property("value");
                update_county_dropdown(selected_state_input);
            });

            function update_county_dropdown(user_state_input) {
                var user_counties = [];
                counties.features.forEach((county, i) => {
                    if (county.properties.state === user_state_input) {
                        user_counties.push(county.properties.county_name);
                    };
                    user_counties.sort();
                });

                d3.selectAll('.county_options')
                    .remove();

                d3.select("#pick_county_input")
                    .selectAll('county_options')
                    .data(user_counties)
                    .enter()
                    .append('option').attr("class", 'county_options')
                    .text(d => { return d; })
                    .attr("value", d => { return d; })

                d3.select("#pick_county_input").on("change", function (d) {
                    var selected_county_input = d3.select(this).property("value");
                    user_county_id_input = find_county_id(user_state_input, selected_county_input);
                    // console.log(user_county_id_input);
                    make_state_map(user_county_id_input, "#user_state");
                });
            };

            function find_county_id(state, county) {
                selected_county_id = "";
                employment.forEach((d, i) => {
                    if (d['State'].trim() === state && d['County'] === county) {
                        selected_county_id = d['FIPS_code'];
                    };
                });
                return selected_county_id;
            };

            //user_input_county_id needs to be made interactive based on user selection
            function make_state_map(county_id, svg_id) {
                var state_projection = d3.geoAlbersUsa().scale(1).translate([0, 0]);
                var state_path = d3.geoPath().projection(state_projection);
                // console.log("in make state map")
                // console.log(county_id);
                // console.log(svg_id);
                const state_svg = d3.select(svg_id);
                const state_width = state_svg.attr("width");
                const state_height = state_svg.attr("height");
                // const state_mapWidth = state_width;
                // const state_mapHeight = state_height;

                user_input_county_id_string = county_id.toString();
                user_input_state_id = user_input_county_id_string.substring(0, 2);

                selected_state = states.features.filter(function (d) {
                    return d.id === user_input_state_id;
                });

                selected_counties = counties.features.filter(function (d) {
                    return d.id.substring(0, 2) === user_input_state_id;
                });

                //source for centering state map: https://bl.ocks.org/gregdevs/a73f8a16f129757c037e72ecdebdd8f2
                var state_bounds = state_path.bounds(selected_state[0]);
                var state_x_difference = state_bounds[1][0] - state_bounds[0][0];
                var state_y_difference = state_bounds[1][1] - state_bounds[0][1];
                var state_x_sum = state_bounds[1][0] + state_bounds[0][0];
                var state_y_sum = state_bounds[1][1] + state_bounds[0][1];

                var state_scale = 0.95 / Math.max(state_x_difference / state_width, state_y_difference / state_height);
                var state_translate = [(state_width - state_scale * state_x_sum) / 2, (state_height - state_scale * state_y_sum) / 2];

                state_projection.scale(state_scale)
                    .translate(state_translate);

                const colorsArray = ["#B5375D", "#DBADA6", "#DEDEDE", "#A1D5ED", "#26C7CB"];

                // does it matter if we use quantize vs quantile?
                const colorScale = d3.scaleQuantize()
                    .domain([0, 1])
                    .range(colorsArray);

                // outline for selected state
                let momesh = state_svg.append("path")
                    .attr("class", "mouseover_outline")
                    .attr("d", "");

                var mo = topojson.mesh(us, us.objects.counties, function (a, b) { return a.id === county_id || b.id === county_id; });
                momesh.datum(mo).attr("d", state_path)

                // console.log(state_path);
                // weird state_path error with california
                //draw state map
                state_svg.selectAll("path.selected_counties").data(selected_counties)
                    .join("path")
                    .attr("class", "selected_counties")
                    .attr("d", state_path)
                    .attr("fill", d => colorScale(Number(d.properties.employment_rate)));

                // state_svg.append("path").datum
                state_svg.append("path").datum(countiesMesh)
                    .attr("class", "outline")
                    .attr("d", state_path);
            };

            // reset button for dropdowns
            d3.select("#reset_button").on("click", function (d) {
                console.log("in reset");
                d3.select("#pick_state_input")
                    .selectAll('state_options')
                    .exit()
                    .remove();

                d3.select("#pick_county_input")
                    .selectAll('county_options')
                    .exit()
                    .remove();
            });
            // BUG: only one svg shows up at a time, not all 3???
            make_state_map(42053, "#state_min");
            make_state_map(46117, "#state_max");

            const colorsArray = ["#B5375D", "#DBADA6", "#DEDEDE", "#A1D5ED", "#26C7CB"];

            // does it matter if we use quantize vs quantile?
            const colorScale = d3.scaleQuantize()
                .domain([0, 1])
                .range(colorsArray);

            //draw us map
            us_svg.selectAll("path.counties").data(counties.features)
                .join("path")
                .attr("class", "counties")
                .attr("d", us_path)
                .attr("fill", d => colorScale(Number(d.properties.employment_rate)));

            us_svg.append("path").datum(statesMesh)
                .attr("class", "outline")
                .attr("d", us_path);



            // PART 2: US MAP WITH COUNTIES WITH UNEMPLOYMENT RATE (Rachel)

            // Filtering by literacy average score (Lit_A)
            // counties.features.forEach((county, i) => {
            //     employment.forEach((d, i) => {
            //         literacy = d['Lit_A'];
            //         if (Number(county.id) === d['FIPS_code']) {
            //             county.properties["literacy"] = literacy;
            //         }
            //     });
            // });
            // console.log(counties);


            // d3.select("buttonLiteracy").append("button");

            // function literacyFilter() {
            //     console.log("testing");
            //     us2map.selectAll("path.counties").data(counties.features)
            //         .join("path")
            //         .attr("class", "counties")
            //         .attr("d", us_path)
            //         .attr("fill", d => colorScale(Number(d.properties.literacy)));
            // }



            // var filters = {};
            // var match = topojson.feature(us, us.objects.counties);

            // function matchCounties(matches) {
            //     console.log("matching", matches)
            //     console.log(filters)
            //     matches = matches.filter(pointPassesFilters)
            //     // data.forEach( d => { d.position = projection([d.Longitude, d.Latitude]);});
            //     console.log(matches)
            // }

            // function makeSlider(container, label, attribute, sliderWidth, sliderHeight) {

            //     let values = employment.map(d => d[attribute] * 100);

            //     let minMax = d3.extent(values);
            //     let xScale = d3.scaleLinear().domain(minMax).range([10, sliderWidth - 10]); // padding here for ease
            //     let xAxis = d3.axisBottom(xScale).tickFormat(d3.format(".2"));

            //     let wrapper = container.append("div").attr("class", "control");
            //     wrapper.append("div").text(label);
            //     let canvas = wrapper.append("svg").attr("width", sliderWidth)
            //         .attr("height", sliderHeight + 20)
            //         .attr("attribute", attribute);
            //     let areaLayer = canvas.append("g");
            //     canvas.append("g").attr("transform", `translate(0,${sliderHeight})`)
            //         .call(xAxis);

            //     let numBins = 10;
            //     let histoGen = d3.histogram().domain(minMax)
            //         .thresholds(numBins);
            //     let counts = histoGen(values);

            //     // To make the line chart smoother, we add a dummy value at the start of the array using unshift
            //     counts.unshift({
            //         x0: 0,
            //         x1: counts[0].x0,
            //         length: counts[0].length
            //     });

            //     let yScale = d3.scaleLinear().domain(d3.extent(counts, d => d.length))
            //         .range([sliderHeight, 4]);

            //     let area = d3.area().x(d => xScale(d.x1))
            //         .y0(yScale(0))
            //         .y1(d => yScale(d.length))
            //         .curve(d3.curveNatural);
            //     areaLayer.append("path").datum(counts)
            //         .attr("class", "area")
            //         .attr("d", area);

            //     let filterFunc = d => true;
            //     filters[attribute] = filterFunc;

            //     // Allow the user to select regions of the slider
            //     var brush = d3.brushX().extent([[10, 0],
            //     [sliderWidth - 10, sliderHeight]])
            //         .on("brush end", brushMoved);

            //     function brushMoved(event) {
            //         console.log(d3.event.type, d3.event.selection);
            //         // Everything but clicking on brush area
            //         if (event.selection !== null) {
            //             let start = xScale.invert(event.selection[0]);
            //             let end = xScale.invert(event.selection[1]);
            //             let filterFunc = d => d[attribute] >= start && d[attribute] <= end;
            //             filters[attribute] = filterFunc;
            //             matchCounties(match)
            //         }
            //         // Clicking on brush area to empty it out
            //         else {
            //             let filterFunc = d => true;
            //             filters[attribute] = filterFunc;
            //             matchCounties(match)
            //         }
            //     }
            //     canvas.append("g").attr("class", "brush").call(brush);
            // }

            // makeSlider(d3.select("#multiple"), "Employment Rate", "Employed", 500, 20)
            // makeSlider(d3.select("#multiple"), "Unemployment Rate", "Unemployed", 500, 20)
            // makeSlider(d3.select("#multiple"), "Poverty", "Poverty_100", 500, 20)


        };
        request_data();


    </script>


</body>

</html>