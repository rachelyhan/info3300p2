<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script src="./tooltip.js"></script>
    <script src="./usMap.js"></script>
    <link rel="stylesheet" href="./styles.css">
</head>

<body>
    <h1>Employment in the United States</h1>

    <h2>Part I: How well-employed is your county?</h2>
    <h3>Select your county below to find out how employment rates in your county compare to other counties in the US.
    </h3>
    <div id="user_state_county_inputs">
        <label for="pick_state_input">Home State: </label>
        <select name="pick_state_input" id="pick_state_input">
            <option value="" disabled selected>Select your state</option>
        </select>

        <label for="pick_county_input">Home County: </label>
        <select name="pick_county_input" id="pick_county_input">
            <option value="" selected>Select your county</option>
        </select>

        <!-- <button type="button" id="reset_button">Reset</button> -->
    </div>
    <br>

    <!-- style="text-align: center; width:1550;" -->
    <div class="colorLegend_elm1" style="margin-left: 525px;">
        <svg id="colorLegend" height="50" width="500" style="background: #fff; margin-right: 100px; font-family: 'Lato', arial;
            font-size: 16px; font-weight: 300;"></svg>
    </div>

    <div class="visualization_1">
        <div class="viz_1_map element_1">
            <svg id="state_min" height="450" width="450"></svg>
        </div>
        <div class="viz_1_map element_2">
            <div id="viz_1_outline">
                <svg id="user_state" height="650" width="650"></svg>
            </div>
        </div>
        <div class="viz_1_map element_3">
            <svg id="state_max" height="450" width="450"></svg>
        </div>
    </div>

    <h2>Part II: Discover other counties</h2>
    <h3>Explore other counties in the US by filtering for various metrics such as income, literacy, and more.</h3>
    <div class="viz2" style="width: 100%">
        <div id="us_div" style="width: 70%; height: 800px; float: left;">
            <svg id="us_map" height="800" style="width: 85%;"></svg>
        </div>
        <div id="filters" style="height:800px; width: 20%; float:left; padding-left: 5%; padding-right: 5%;"></div>
    </div>


    <div class="viz3_title">
        <h2>Part III: Compare two counties</h2>
        <h3>Based on your exploration from Part II, compare and contrast two counties you are interested in</h3>
    </div>
    <div id="v3" style="display: flex">
        <div class="v3_map element_1" style="width: 50%">
            <svg id="v3_c1" height="650" width="650"></svg>
        </div>
        <div class="v3_map element_2" style="width: 50%">
            <svg id="v3_c2" height="650" width="650"></svg>
        </div>
    </div>
    <div class="miniGraphs">
        <svg id="hs_graph" height="300" width="500" style="margin-top: 50px;"></svg>
        <svg id="empty space" height="300" width="50"></svg>
        <svg id="employment_graph" height="300" width="500" style="margin-top: 50px;"></svg>
        <svg id="empty space" height="300" width="300" style="margin-top: 50px;"></svg>

        <svg id="ethnicity_graph1" height="300" width="250" style="margin-top: 50px;"></svg>
        <svg id="ethnicity_graph2" height="300" width="250" style="margin-top: 50px;"></svg>
        <svg id="empty space" height="300" width="50"></svg>
        <svg id="gender_graph1" height="300" width="250" style="margin-top: 50px;"></svg>
        <svg id="gender_graph2" height="300" width="250" style="margin-top: 50px;"></svg>

    </div>

    <script>
        // PART 1: COUNTY VISUALIZATION (SHRUTI)
        const us_svg = d3.select("#us_map");

        const request_data = async function () {
            const us = await d3.json("counties-10m.json");

            var us_projection = d3.geoAlbersUsa().scale(1300).translate([487.5, 400]);
            var us_path = d3.geoPath().projection(us_projection);

            var nation = topojson.feature(us, us.objects.nation);
            var states = topojson.feature(us, us.objects.states)
            var counties = topojson.feature(us, us.objects.counties);

            var statesMesh = topojson.mesh(us, us.objects.states);
            var countiesMesh = topojson.mesh(us, us.objects.counties);

            // import datasets and populate new json
            var zip_codes = await d3.csv("fipscode_zipcode.csv", d3.autoType);
            var employment = await d3.csv("employment_data.csv", d3.autoType);
            var education = await d3.csv("education.csv", d3.autoType);
            var income = await d3.csv("unemployment_income.csv", d3.autoType);

            data = {}
            counties.features.forEach((county, i) => {
                data[Number(county.id)] = {};
            })

            employment.forEach((d, i) => {
                const id = d['FIPS_code'].toString()
                data[id]["employment_rate"] = d['Employed'];
                data[id]["state"] = d['State'].trim();
                data[id]["county_name"] = d['County'];
                data[id]["literacy"] = d["Lit_P3"];
                data[id]["OCC_Manage"] = 100 * d["OCC_Manage"];
                data[id]["OCC_Service"] = 100 * d["OCC_Service"];
                data[id]["OCC_Sales"] = 100 * d["OCC_Sales"];
                data[id]["OCC_Military"] = 100 * d["OCC_Military"];
                data[id]["OCC_Prod"] = 100 * d["OCC_Prod"];
                data[id]["Male"] = 100 * d["Male"];
                data[id]["Female"] = 100 * d["Female"];
                data[id]["White"] = 100 * d["White"];
                data[id]["Black"] = 100 * d["Black"];
                data[id]["Hispanic"] = 100 * d["Hispanic"];
                data[id]["Asian"] = 100 * d["Asian"];
                data[id]["AIAN"] = 100 * d["AIAN"];
                data[id]["NHPI"] = 100 * d["NHPI"];
                data[id]["Other_race"] = 100 * d["Other_race"];
            });

            education.forEach((d, i) => {
                const id = d['FIPS Code'];
                if (id in data) {
                    data[id]["high_school"] = d['Percent of adults with a high school diploma only, 2015-19'] + d["Percent of adults completing some college or associate's degree, 2015-19"] + d["Percent of adults with a bachelor's degree or higher, 2015-19"];
                    data[id]["college"] = d["Percent of adults with a bachelor's degree or higher, 2015-19"];
                    data[id]["Percent of adults with less than a high school diploma, 2015-19"] = d["Percent of adults with less than a high school diploma, 2015-19"];
                    data[id]["Percent of adults with a high school diploma only, 2015-19"] = d["Percent of adults with a high school diploma only, 2015-19"];
                    data[id]["Percent of adults with a bachelor's degree or higher, 2015-19"] = d["Percent of adults with a high school diploma only, 2015-19"];
                    data[id]["state_abbreviation"] = d['State'];
                }
            });


            // median income not pulling the right values
            income.forEach((d, i) => {
                const id = d['fips_txt']
                if (id in data && ["Attribute" === "Median_Household_Income_2019"]) {
                    data[id]["income"] = d["Value"]
                    // console.log(id)
                    // console.log(d["Value"])
                }
            });

            // color scale constants
            var all_employment_values = [];
            employment.forEach((d, i) => {
                all_employment_values.push(d['Employed'])
            });

            const colorsArray = ["#B5375D", "#DBADA6", "#DEDEDE", "#A1D5ED", "#26C7CB"];

            // array of all states to dropdown
            var all_states = [];
            states.features.forEach((state, i) => {
                state_name = state.properties.name;
                if (state_name != "Guam" && state_name != "American Samoa" && state_name != "Commonwealth of the Northern Mariana Islands" && state_name != "District of Columbia" && state_name != "United States Virgin Islands" && state_name != "Puerto Rico") {
                    all_states.push(state_name);
                }
            });
            all_states.sort();

            // add all states to select button
            d3.select("#pick_state_input")
                .selectAll('state_options')
                .data(all_states)
                .enter()
                .append('option')
                .text(d => { return d; })
                .attr("value", d => { return d; })

            // update county dropdown based on state selection
            d3.select("#pick_state_input").on("change", function (d) {
                var selected_state_input = d3.select(this).property("value");
                //var selected_state_input = "New York";
                update_county_dropdown(selected_state_input);
            });

            function update_county_dropdown(user_state_input) {
                var user_counties = [];
                Object.keys(data).forEach((county) => {
                    if (data[county]['state'] === user_state_input) {
                        user_counties.push(data[county]['county_name']);
                    };
                    user_counties.sort();
                });

                d3.selectAll('.county_options')
                    .remove();

                d3.select("#pick_county_input")
                    .selectAll('county_options')
                    .data(user_counties)
                    .enter()
                    .append('option').attr("class", 'county_options')
                    .text(d => { return d; })
                    .attr("value", d => { return d; })

                d3.select("#pick_county_input").on("change", function (d) {
                    var selected_county_input = d3.select(this).property("value");
                    user_county_id_input = find_county_id(user_state_input, selected_county_input);
                    make_state_map(42053, "#state_min", "#state_min_title");
                    make_state_map(46117, "#state_max", "#state_max_title");
                    make_state_map(user_county_id_input, "#user_state", "#user_state_title");

                    //VISUALIZATION 2: US MAP + FILTERS
                    const sliderWidth = 400
                    const sliderHeight = 20
                    makeSlider(d3.select("#filters"), "Employment Rate", "employment_rate", sliderHeight, sliderWidth, counties, us_path, statesMesh, user_county_id_input, data)
                    makeSlider(d3.select("#filters"), "Median Household Income", "income", sliderHeight, sliderWidth, counties, us_path, statesMesh, user_county_id_input, data)
                    makeSlider(d3.select("#filters"), "Adult Literacy", "literacy", sliderHeight, sliderWidth, counties, us_path, statesMesh, user_county_id_input, data)
                    makeSlider(d3.select("#filters"), "Completed High School", "high_school", sliderHeight, sliderWidth, counties, us_path, statesMesh, user_county_id_input, data)
                    makeSlider(d3.select("#filters"), "Completed College", "college", sliderHeight, sliderWidth, counties, us_path, statesMesh, user_county_id_input, data)

                    drawUS(counties, us_path, statesMesh, data)

                });
            };

            function find_county_id(state, county) {
                selected_county_id = "";
                employment.forEach((d, i) => {
                    if (d['State'].trim() === state && d['County'] === county) {
                        selected_county_id = d['FIPS_code'];
                    };
                });
                return selected_county_id;
            };

            function make_state_map(county_id, svg_id, title_id) {
                d3.select(svg_id).selectAll("*").remove();
                var state_projection = d3.geoAlbersUsa().scale(1).translate([0, 0]);
                var state_path = d3.geoPath().projection(state_projection);

                const state_svg = d3.select(svg_id);
                const state_width = state_svg.attr("width");
                const state_height = state_svg.attr("height");

                const margin = { top: 100, right: 100, bottom: 100, left: 100 };
                const mapWidth = state_width - margin.left - margin.right;
                const mapHeight = state_height - margin.top - margin.bottom;
                const map = state_svg.append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                user_input_county_id_string = county_id.toString();

                if (user_input_county_id_string.length === 4) {
                    user_input_state_id = "0" + user_input_county_id_string.substring(0, 1);
                }
                else {
                    user_input_state_id = user_input_county_id_string.substring(0, 2);
                }

                selected_state = states.features.filter(function (d) {
                    return d.id === user_input_state_id;
                });

                selected_counties = counties.features.filter(function (d) {
                    return d.id.substring(0, 2) === user_input_state_id;
                });


                //source for centering state map: https://bl.ocks.org/gregdevs/a73f8a16f129757c037e72ecdebdd8f2
                var state_bounds = state_path.bounds(selected_state[0]);
                var state_x_difference = state_bounds[1][0] - state_bounds[0][0];
                var state_y_difference = state_bounds[1][1] - state_bounds[0][1];
                var state_x_sum = state_bounds[1][0] + state_bounds[0][0];
                var state_y_sum = state_bounds[1][1] + state_bounds[0][1];

                var state_scale = 0.95 / Math.max(state_x_difference / mapWidth, state_y_difference / mapHeight);
                var state_translate = [(mapWidth - state_scale * state_x_sum) / 2, (mapHeight - state_scale * state_y_sum) / 2];

                state_projection.scale(state_scale)
                    .translate(state_translate);

                const colorScale = d3.scaleQuantile()
                    .domain(all_employment_values)
                    .range(colorsArray);

                drawLegend("#colorLegend", colorScale);

                map.selectAll("path.selected_counties")
                    .remove();

                //draw state map
                map.selectAll("path.selected_counties").data(selected_counties)
                    .join("path")
                    .attr("class", "selected_counties")
                    .attr("d", state_path)
                    .attr("fill", d => colorScale(Number(data[Number(d.id)]["employment_rate"])));

                map.append("path").datum(countiesMesh)
                    .attr("class", "outline")
                    .attr("d", state_path);

                // add state label
                state_svg.selectAll("text")
                    .remove();

                state_svg.append("text")
                    .attr("x", state_width / 2)
                    .attr("y", 105)
                    .attr("text-anchor", "middle")
                    .style("font-weight", 600)
                    .style("font-size", "16px")
                    .text(data[county_id]["county_name"] + ", " + data[county_id]["state_abbreviation"]);


                // add metrics
                const attributes = ["Employment Rate: ", "Median Household Income: ", "Pop. % at Level 3 Literacy: ", "Pop. % with Bachelors' Degrees: ", "Pop. % of High School Graduates: "];

                attributes.forEach((d, i) => {
                    state_svg.append("text")
                        .attr("x", 0.10 * state_width)
                        .attr("y", state_height - (100 - 20 * i))
                        .style("font-weight", 600)
                        .style("font-size", "14px")
                        .text(d);
                });

                const metrics = [(Math.round(data[Number(county_id)]["employment_rate"] * 100).toString() + "%"),
                (data[Number(county_id)]["income"].toString() + "K"),
                (Math.round((data[Number(county_id)]["literacy"] * 100).toString()) + "%"),
                (Math.round(data[Number(county_id)]["college"]) + "%"),
                (Math.round(data[Number(county_id)]["high_school"]) + "%")];

                // console.log(typeof state_width)
                if (state_width === "450") {
                    metrics.forEach((d, i) => {
                        state_svg.append("text")
                            .attr("x", 0.57 * state_width)
                            .attr("y", state_height - (100 - 20 * i))
                            .style("font-weight", 300)
                            .style("font-size", "14px")
                            .text(d)
                    })
                }
                else {
                    metrics.forEach((d, i) => {
                        state_svg.append("text")
                            .attr("x", 0.42 * state_width)
                            .attr("y", state_height - (100 - 20 * i))
                            .style("font-weight", 300)
                            .style("font-size", "14px")
                            .text(d);
                    })
                };

                // outline for selected state
                let momesh = map.append("path")
                    .attr("class", "select_outline")
                    .attr("d", "");

                map.append("path")
                    .attr("class", "mouseover_outline")
                    .attr("d", "")
                    .attr("id", "momesh")

                var mo = topojson.mesh(us, us.objects.counties, function (a, b) { return a.id === county_id.toString() || b.id === county_id.toString(); });
                momesh.datum(mo).attr("d", state_path)

                add_tooltip(svg_id, state_path, data, us)
            };

            // reset button for dropdowns
            // d3.select("#reset_button").on("click", function (d) {
            //     console.log("in reset");
            //     d3.select("#pick_state_input")
            //         .selectAll('state_options')
            //         .exit()
            //         .remove();

            //     d3.select("#pick_county_input")
            //         .selectAll('county_options')
            //         .exit()
            //         .remove();
            // });

            function drawLegend(legend_id, legendColorScale) {

                // Bonus code here to draw an adaptive gradient legend so we can see different color scales for choropleth maps
                //  Credit Prof. Rz if you are basing a legend on this structure, and note SERIOUS PERFORMANCE CONSIDERATIONS
                // Source: Professor. Rz, INFO 3300 Spring 2021 Cornell University, Lecture 03/22
                const legend = d3.select(legend_id);
                const legendWidth = legend.attr("width");
                const legendHeight = legend.attr("height");
                const legendMinMax = d3.extent(legendColorScale.domain()); // way to recover the minMax from most kinds of scales
                const barHeight = 20;
                const stepSize = 4; // warning, not using a canvas element so lots of rect tags will be created for low stepSize, causing issues with performance
                // Extend the minmax by 1 in either direction to expose more features
                const pixelScale = d3.scaleLinear().domain([0, legendWidth - 40]).range([legendMinMax[0], legendMinMax[1]]); // In this case the "data" are pixels, and we get numbers to use in colorScale
                const barScale = d3.scaleLinear().domain([legendMinMax[0], legendMinMax[1]]).range([0, legendWidth - 40]);
                const barAxis = d3.axisBottom(barScale);
                // Check if we're using a quantile scale - if so, we can do better
                if (legendColorScale.hasOwnProperty('quantiles')) {
                    // Use the quantile breakpoints plus the min and max of the scale as tick values
                    barAxis.tickValues(legendColorScale.quantiles().concat(legendMinMax));
                }
                legend.append("g")
                    .attr("class", "colorbar axis")
                    .attr("transform", "translate(" + (20) + "," + (barHeight + 5) + ")")
                    .call(barAxis);
                // Draw rects of color down the bar
                let bar = legend.append("g").attr("transform", "translate(" + (20) + "," + (0) + ")")
                for (let i = 0; i < legendWidth - 40; i = i + stepSize) {
                    bar.append("rect")
                        .attr("x", i)
                        .attr("y", 0)
                        .attr("width", stepSize)
                        .attr("height", barHeight)
                        .style("fill", legendColorScale(pixelScale(i))); // pixels => countData => color
                }
                // Put lines in to mark actual min and max of our data
                bar.append("line").attr("stroke", "white").attr("stroke-width", 3).attr("x1", barScale(legendMinMax[0])).attr("x2", barScale(legendMinMax[0])).attr("y1", 0).attr("y1", barHeight + 4);
                bar.append("line").attr("stroke", "white").attr("stroke-width", 3).attr("x1", barScale(legendMinMax[1])).attr("x2", barScale(legendMinMax[1])).attr("y1", 0).attr("y1", barHeight + 4);
            };

            const colorScale = d3.scaleQuantile()
                .domain(all_employment_values)
                .range(colorsArray);

            //PART 3: COMPARE COUNTIES (CRYSTAL)
            var compare1 = 2016
            var compare2 = 36027
            make_state_map(compare1, "#v3_c1", "#v3_c1_title");
            make_state_map(compare2, "#v3_c2", "#v3_c2_title");




            const svg_education = d3.select("svg#hs_graph");
            const svg_employment = d3.select("svg#employment_graph");

            // function to create bar charts 
            function bar_charts(svg, title, x_list, y_list, max) {
                const width = svg.attr("width");
                const height = svg.attr("height");
                const margin = { "top": 40, "right": 10, "bottom": 50, "left": 60 };
                const chartWidth = width - margin.left - margin.right;
                const chartHeight = height - margin.top - margin.bottom

                let annotations = svg.append("g").attr("id", "annotations");
                let chartArea = svg.append("g").attr("id", "points")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                const yaxisScale = d3.scaleLinear().domain([0, 100]).range([chartHeight, 0])
                let leftAxis = d3.axisLeft(yaxisScale).tickFormat(d3.format(''));
                let leftGridlines = d3.axisLeft(yaxisScale)
                    .tickSize(-chartWidth - 10)
                    .tickFormat("")

                annotations.append("g")
                    .attr("class", "y axis")
                    .attr("transform", `translate(${margin.left - 10},${margin.top})`)
                    .call(leftAxis)
                annotations.append("g")
                    .attr("class", "y gridlines")
                    .attr("transform", `translate(${margin.left - 10},${margin.top})`)
                    .call(leftGridlines);

                const xaxisScale = d3.scalePoint()
                    .domain(x_list)
                    .range([20, chartWidth - 70]);

                const xaxisScale2 = d3.scalePoint()
                    .domain(x_list)
                    .range([50, chartWidth - 40]);

                let bottomAxis = d3.axisBottom(xaxisScale)
                let bottomAxisG = annotations.append("g")
                    .attr("class", "x axis")
                    .attr("transform", `translate(${margin.left},${chartHeight + margin.top + 10})`)
                    .call(bottomAxis);

                // chart title
                svg.append("text")
                    .attr("x", width / 2)
                    .attr("y", 25)
                    .style("text-anchor", "middle")
                    .style("font-weight", 600)
                    .style("font-size", "16px")
                    .text(title);

                // county 1 label
                svg.append("text")
                    .attr("x", width - 50)
                    .attr("y", 20)
                    .style("text-anchor", "middle")
                    .style("font-weight", 200)
                    .style("stroke", "blue")
                    .text("County 1");

                // county 2 label
                svg.append("text")
                    .attr("x", width - 50)
                    .attr("y", 35)
                    .style("text-anchor", "middle")
                    .style("font-weight", 200)
                    .style("stroke", "red")
                    .text("County 2");

                // x axis labels
                // svg.append("text")
                //     .attr("x", width / 2)
                //     .attr("y", height)
                //     .style("text-anchor", "middle")
                //     .style("font-weight", 600);

                // y axis label
                svg.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 0)
                    .attr("x", 0 - (height / 2))
                    .attr("dy", "1em")
                    .style("text-anchor", "middle")
                    .style("font-weight", 600)
                    .text("Percentage");

                // draw County 1 rectangles
                for (i = 0; i < max; i++) {
                    chartArea.append("line")
                        .attr("x1", xaxisScale(x_list[i]))
                        .attr("x2", xaxisScale(x_list[i]))
                        .attr("y1", chartHeight)
                        .attr("y2", yaxisScale(data[compare1][y_list[i]]))
                        .style("stroke", "blue")
                        .style("stroke-width", 30);
                }

                // draw County 2 rectangles
                for (i = 0; i < max; i++) {
                    chartArea.append("line")
                        .attr("x1", xaxisScale2(x_list[i]))
                        .attr("x2", xaxisScale2(x_list[i]))
                        .attr("y1", chartHeight)
                        .attr("y2", yaxisScale(data[compare2][y_list[i]]))
                        .style("stroke", "red")
                        .style("stroke-width", 30);
                }
            };

            // draw bar charts
            bar_charts(svg_education, "Education", ["less than HS education", "only HS education",
                "more than HS education"], ["Percent of adults with less than a high school diploma, 2015-19",
                "Percent of adults with a high school diploma only, 2015-19",
                "Percent of adults with a bachelor's degree or higher, 2015-19"], 3);

            bar_charts(svg_employment, "Employment", ["Management", "Service", "Sales", "Military", "Production"],
                ["OCC_Manage", "OCC_Service", "OCC_Sales", "OCC_Military", "OCC_Prod"], 5);


            // function bar_charts () {

            // };

            // GENDER RATIO PIE CHART CHART MINI GRAPH
            const svg3 = d3.select("svg#gender_graph1");
            const svg3_part2 = d3.select("svg#gender_graph2");
            const width3 = svg3.attr("width");
            const height3 = svg3.attr("height");
            const margin3 = 70;
            const radius = Math.min(width3, height3) / 2 - margin3;

            g = svg3.append("g").attr("transform", "translate(" + width3 / 2 + "," + height3 / 2 + ")");
            g2 = svg3_part2.append("g").attr("transform", "translate(" + width3 / 2 + "," + height3 / 2 + ")");

            //chart title
            svg3.append("text")
                .attr("x", width3 / 2)
                .attr("y", 20)
                .style("text-anchor", "middle")
                .style("font-weight", 600)
                .style("font-size", "16px")
                .text("Gender Graph");

            // Male label
            svg3_part2.append("text")
                .attr("x", width3 - 125)
                .attr("y", 25)
                .style("text-anchor", "middle")
                .style("font-weight", 200)
                .style("stroke", "blue")
                .text("Male");

            // Female label
            svg3_part2.append("text")
                .attr("x", width3 - 125)
                .attr("y", 40)
                .style("text-anchor", "middle")
                .style("font-weight", 200)
                .style("stroke", "red")
                .text("Female");

            // County 1 label
            svg3.append("text")
                .attr("x", width3 / 2)
                .attr("y", height3 - 65)
                .style("text-anchor", "middle")
                .style("font-weight", 200)
                .text("County 1");

            // County 2 label
            svg3_part2.append("text")
                .attr("x", width3 / 2)
                .attr("y", height3 - 65)
                .style("text-anchor", "middle")
                .style("font-weight", 200)
                .text("County 2");

            var gender_data1 = [100 * data[compare1]["Male"], 100 * data[compare1]["Female"]];
            var gender_data2 = [100 * data[compare2]["Male"], 100 * data[compare2]["Female"]];
            var color3 = d3.scaleOrdinal(['blue', 'red']);

            // Generate the pie
            var pie = d3.pie();
            var pie2 = d3.pie();

            // Generate the arcs
            var arc = d3.arc()
                .innerRadius(20)
                .outerRadius(radius);

            var arc2 = d3.arc()
                .innerRadius(20)
                .outerRadius(radius);

            //Generate groups
            var arcs = g.selectAll("arc")
                .data(pie(gender_data1))
                .enter()
                .append("g")
                .attr("class", "arc")

            var arcs2 = g2.selectAll("ar2")
                .data(pie2(gender_data2))
                .enter()
                .append("g")
                .attr("class", "arc2")

            //Draw arc paths
            arcs.append("path")
                .attr("fill", function (d, i) {
                    return color3(i);
                })
                .attr("d", arc);

            arcs2.append("path")
                .attr("fill", function (d, i) {
                    return color3(i);
                })
                .attr("d", arc2);





            // ETHNICITY OF PIE CHART CHART MINI GRAPH
            const svg4 = d3.select("svg#ethnicity_graph1");
            const svg4_part2 = d3.select("svg#ethnicity_graph2");
            const width4 = svg4.attr("width");
            const height4 = svg4.attr("height");
            const margin4 = 70;
            const radius4 = Math.min(width4, height4) / 2 - margin4;

            g4 = svg4.append("g").attr("transform", "translate(" + width4 / 2 + "," + height4 / 2 + ")");
            g5 = svg4_part2.append("g").attr("transform", "translate(" + width4 / 2 + "," + height4 / 2 + ")");

            //chart title
            svg4.append("text")
                .attr("x", width4 / 2)
                .attr("y", 20)
                .style("text-anchor", "middle")
                .style("font-weight", 600)
                .style("font-size", "16px")
                .text("Ethnicity Graph");

            // County 1 label
            svg4.append("text")
                .attr("x", width4 / 2)
                .attr("y", height4 - 65)
                .style("text-anchor", "middle")
                .style("font-weight", 200)
                .text("County 1");

            // County 2 label
            svg4_part2.append("text")
                .attr("x", width4 / 2)
                .attr("y", height4 - 65)
                .style("text-anchor", "middle")
                .style("font-weight", 200)
                .text("County 2");

            var ethnicity_data1 = [100 * data[compare1]["White"], 100 * data[compare1]["Black"],
            100 * data[compare1]["Hispanic"], 100 * data[compare1]["Asian"],
            100 * data[compare1]["AIAN"], 100 * data[compare1]["NHPI"],
            100 * data[compare1]["Other_race"]];
            var ethnicity_data2 = [100 * data[compare2]["White"], 100 * data[compare2]["Black"],
            100 * data[compare2]["Hispanic"], 100 * data[compare2]["Asian"],
            100 * data[compare2]["AIAN"], 100 * data[compare2]["NHPI"],
            100 * data[compare2]["Other_race"]];
            var color3 = d3.scaleOrdinal(['blue', 'red', 'green', 'orange', 'purple', 'gray', 'pink']);

            // Colored graph labels
            const ethnicity_y_pixels = [10, 25, 40, 55, 10, 25, 40, 55];
            const ethnicity_x_pixels = [200, 200, 200, 200, 100, 100, 100, 100];
            const ethnicity_labels = ["White", "Black", "Hispanic", "Asian",
                "Native American", "Pacific Islander",
                "Other or", "Combination"]
            const ethnicity_colors = ['blue', 'red', 'green', 'orange', 'purple', 'gray', 'pink', 'pink'];

            for (i = 0; i < 8; i++) {
                svg4_part2.append("text")
                    .attr("x", width4 - ethnicity_x_pixels[i])
                    .attr("y", ethnicity_y_pixels[i])
                    .style("font-weight", 200)
                    .attr("font-size", "13px")
                    .style("stroke", ethnicity_colors[i])
                    .text(ethnicity_labels[i]);
            }

            // Generate the pie
            var pie4 = d3.pie();
            var pie5 = d3.pie();

            // Generate the arcs
            var arc4 = d3.arc()
                .innerRadius(20)
                .outerRadius(radius);

            var arc5 = d3.arc()
                .innerRadius(20)
                .outerRadius(radius);

            //Generate groups
            var arcs4 = g4.selectAll("arc")
                .data(pie4(ethnicity_data1))
                .enter()
                .append("g")
                .attr("class", "arc4")

            var arcs5 = g5.selectAll("ar2")
                .data(pie5(ethnicity_data2))
                .enter()
                .append("g")
                .attr("class", "arc5")

            //Draw arc paths
            arcs4.append("path")
                .attr("fill", function (d, i) {
                    return color3(i);
                })
                .attr("d", arc4);

            arcs5.append("path")
                .attr("fill", function (d, i) {
                    return color3(i);
                })
                .attr("d", arc5);
        };
        request_data();
    </script>
</body>

</html>